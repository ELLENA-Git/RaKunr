(function(h){var n=function(a){a||(a="transform");var c=document.defaultView.getComputedStyle(document.body,"");return c[a]?"":c["-webkit-"+a]?"-webkit-":c["-moz-"+a]?"-moz-":c["-o-"+a]?"-o-":c["-khtml-"+a]?"-khtml-":!1}(),l=function(a,c){this.$el=h(a);this.el=a[0];this._create(c)};l.defaultClass="waterfall";h.extend(l.prototype,{options:{colMinWidth:300,defaultContainerWidth:window.clientWidth,autoresize:!0,maxCols:16,updateDelay:45,useCalc:void 0,useTranslate3d:void 0,animateShow:!1,reflow:null},
_create:function(a){var c=this;a=c.options=h.extend({},c.options,a);this.items=[];c.lastHeights=[];c.lastItems=[];c.colPriority=[];c.baseOrder=[];var b=getComputedStyle(c.el);c.el.hidden=!0;c.el.style.minHeight=b.height;"static"===c.$el.css("position")&&(c.el.style.position="relative");void 0===a.useCalc&&(this.prefixedCalc=function(){for(var a=document.createElement("div"),c=["calc","-webkit-calc","-moz-calc","-o-calc"],b=0;b<c.length;++b){var d=c[b],e=d+"(1px)";a.style.cssText=n+"transform: translate3d("+
[e,e,e].join()+");";if(a.style.length&&14<a.style[n+"transform"].length)return d}}(),a.useCalc=!!this.prefixedCalc);void 0===a.useTranslate3d&&(this.prefixedTranslate3d=function(){for(var a=document.createElement("div"),c=["translate3d","-webkit-translate3d","-moz-translate3d","-o-translate3d"],b=0;b<c.length;++b){var d=c[b];a.style.cssText=n+"transform:"+d+"(1px, 0, 0);";if(a.style.length)return d}}(),a.useTranslate3d=!!this.prefixedTranslate3d);for(var b=c.$el.children(),d=0;d<c.el.childNodes.length;)1!==
c.el.childNodes[d].nodeType&&8!==c.el.childNodes[d].nodeType?c.el.removeChild(c.el.childNodes[d]):d++;b.each(function(a,b){c._addItem(b);c._initItem(b)});c.lastItem=c.items[c.items.length-1];c.el.removeAttribute("hidden");c._update();a.autoresize&&h(window).resize(c.reflow.bind(c));this._observeMutations()},_addItem:function(a){a.getAttribute("data-exclude")||this.items.push(a)},_observeMutations:function(){if(window.MutationObserver)this.observer=new MutationObserver(function(a){for(var c=a.length,
b=0;b<c;b++)if(a[b].removedNodes.length&&this._removedItems(Array.prototype.slice.apply(a[b].removedNodes)),a[b].addedNodes.length){var d=Array.prototype.slice.apply(a[b].addedNodes);a[b].nextSibling?this._insertedItems(d):this._appendedItems(d)}}.bind(this)),this.observer.observe(this.el,{attributes:!1,childList:!0,characterData:!1});else this.$el.on("DOMNodeInserted",function(a){a=(a.originalEvent||a).target;(1===a.nodeType||8===a.nodeType)&&a.parentNode===this.el&&(!a.previousSibling||!a.previousSibling.span||
a.nextSibling&&a.nextSibling.span?this._insertedItems([a]):this._appendedItems([a]))}.bind(this)).on("DOMNodeRemoved",function(a){a=(a.originalEvent||a).target;1!==a.nodeType&&8!==a.nodeType||a.parentNode!==this.el||this._removedItems([a])}.bind(this))},reflow:function(){var a=this.options;window.clearTimeout(this._updateInterval);this._updateInterval=window.setTimeout(this._update.bind(this),a.updateDelay);return this},_appendedItems:function(a){for(var c=a.length,b=0;b<c;b++){var d=a[b];1===d.nodeType&&
(this._addItem(d),this._initItem(d),this._setItemWidth(d))}for(b=0;b<c;b++)1===a[b].nodeType&&this._placeItem(a[b]);this.lastItem=this.items[this.items.length-1];this._maximizeHeight()},_insertedItems:function(a){this.items.length=0;for(var c=a.length,b=0;b<c;b++){var d=a[b];if(1===d.nodeType||8===d.nodeType)this._initItem(d),this._setItemWidth(d)}a=this.el.childNodes;c=a.length;for(b=0;b<c;b++)(1===a[b].nodeType||8===d.nodeType)&&a[b].span&&this._addItem(a[b]);this.lastItem=this.items[this.items.length-
1];this.reflow()},_removedItems:function(a){for(var c=0;c<a.length;c++)this.items.splice(this.items.indexOf(a[c]),1);this.lastItem=this.items[this.items.length-1];this.reflow()},_trigger:function(a,c){try{this.options[a]&&this.options[a].call(this.$el,c),this.$el.trigger(a,[c])}catch(b){throw b;}},_initItem:function(a){var c=this.options,b=a.getAttribute("data-span")||1,d=a.getAttribute("data-float")||a.getAttribute("data-column"),b="all"===b?c.maxCols:Math.max(0,Math.min(~~b,c.maxCols));a.span=b;
var f=getComputedStyle(a);a.mr=~~f.marginRight.slice(0,-2);a.ml=~~f.marginLeft.slice(0,-2);a.bt=~~f.borderTopWidth.slice(0,-2);a.bb=~~f.borderBottomWidth.slice(0,-2);a.mt=~~f.marginTop.slice(0,-2);a.mb=~~f.marginBottom.slice(0,-2);a.style.position="absolute";switch(d){case null:a.floatCol=null;break;case "right":case "last":a.floatCol=-b;break;case "left":case "first":a.floatCol=0;break;default:a.floatCol=~~d-1}c.animateShow&&(c.useTranslate3d||(a.style.top=this.lastHeights[this.colPriority[this.colPriority.length-
1]]+"px",a.style.left=this.colWidth*this.colPriority[this.colPriority.length-1]+"px"),a.removeAttribute("hidden"))},_initLayoutParams:function(){var a=this.options,c=window.getComputedStyle(this.el),b=0,d=this.lastItems.length;this.pl=~~c.paddingLeft.slice(0,-2);this.pt=~~c.paddingTop.slice(0,-2);this.pr=~~c.paddingRight.slice(0,-2);this.pb=~~c.paddingBottom.slice(0,-2);this.lastHeights.length=0;this.colPriority.length=0;this.baseOrder.length=0;this.colWidth=this.el.offsetWidth-this.pl-this.pr;this.lastItems.length=
~~(this.colWidth/a.colMinWidth)||1;c=a.useTranslate3d?0:this.pt;for(b=0;b<this.lastItems.length;b++)this.lastHeights.push(c),this.baseOrder.push(b),this.colPriority.push(b);this.colWidth/=this.lastItems.length;if(!a.useCalc||d!==this.lastItems.length)for(b=this.items.length;b--;)this._setItemWidth(this.items[b]);return this.lastItems.length},_updateInterval:0,_update:function(a,c){var b=0,b=a||0,d=c||this.items.length;for(this._initLayoutParams();b<d;b++)this._placeItem(this.items[b]);this._maximizeHeight();
this._trigger("reflow")},_setItemWidth:function(a){var c=a.span>this.lastItems.length?this.lastItems.length:a.span,b=c/this.lastItems.length;this.options.useCalc?(a.w=100*b,a.style.width=this.prefixedCalc+"("+100*b+"% - "+(a.mr+a.ml+(this.pl+this.pr)*b)+"px)"):(a.w=~~(this.colWidth*c-(a.ml+a.mr)),a.style.width=a.w+"px")},_placeItem:function(a){var c=this.options,b=this.lastHeights,d=this.lastItems,f=this.colPriority,g=0,h=0,k=0,e=0,e=0,k=a.span>d.length?d.length:a.span,g=0,m=[],l=[];(e=a.floatCol)&&
(e=0<e?Math.min(e,d.length-k):d.length+e);if(1===k){if(null===e)g=f.shift();else for(g=e,e=0;e<f.length;e++)if(f[e]==g){f.splice(e,1);break}m.push(g);h=b[g]}else if(k>=d.length)g=0,h=b[f[f.length-1]],m=this.baseOrder.slice(),m.length=b.length,f.length=0;else{if(null!==e)g=e,h=Math.max.apply(Math,b.slice(g,g+k));else for(l.length=0,h=Infinity,e=g=0;e<=d.length-k;e++)l[e]=Math.max.apply(Math,b.slice(e,e+k)),l[e]<h&&(g=e,h=l[e]);for(e=0;e<f.length;)f[e]>=g&&f[e]<g+k?m.push(f.splice(e,1)[0]):e++}a.top=
~~h;c.useTranslate3d?(e=100*g/k+"% + "+~~((a.ml+a.mr)*g/k)+"px",a.style[n+"transform"]=c.useCalc?this.prefixedTranslate3d+"( "+this.prefixedCalc+"("+e+"), "+a.top+"px, 0)":this.prefixedTranslate3d+"("+~~(this.colWidth*g)+"px, "+a.top+"px, 0)"):(a.style.top=a.top+"px",a.style.left=this.colWidth*g+this.pl+"px");a.removeAttribute("hidden");g=this._getBottom(a);for(e=0;e<m.length;e++)d[m[e]]=a,this.lastHeights[m[e]]=g;for(e=f.length;e--;)if(k=this.lastHeights[f[e]],g>=k){Array.prototype.splice.apply(f,
[e+1,0].concat(m));break}f.length<b.length&&Array.prototype.unshift.apply(f,m)},_getBottom:function(a){return a?a.top+a.offsetHeight+a.bt+a.bb+a.mb+a.mt:0},_maximizeHeight:function(){this.el.style.minHeight=this.lastHeights[this.colPriority[this.colPriority.length-1]]+this.pb+(this.options.useTranslate3d?this.pt:0)+"px"}});h.fn.waterfall=function(a,c){if("string"==typeof a)return h(this).each(function(b,d){h(d).data("waterfall")[a](c)});if(!this.length)throw Error("No element passed to waterfall");
var b=h(this),d=h.extend({},{colMinWidth:~~b[0].getAttribute("data-col-min-width")||~~b[0].getAttribute("data-width")},a);d.width&&!d.colMinWidth&&(d.colMinWidth=d.width);d=new l(b,d);b.data("waterfall")||b.data("waterfall",d);return d};h(function(){h("."+(window.waterfall&&window.waterfall.defaultClass||l.defaultClass)).each(function(a,c){h(c).waterfall(window.waterfall||{})})})})(Zepto);